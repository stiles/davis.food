name: update

on:
  # Ever hour at the 5th minute
  schedule:
    - cron: '5 * * * *'
  
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  fetch-data:
    name: Fetch and process data
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Fetch new posts and reviews
        env:
          TIKAPI_KEY: ${{ secrets.TIKAPI_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Fetching new posts only (reviews are manually curated)..."
          python scripts/fetch_archive.py --update
          echo "Note: To extract reviews for new posts, run manually: python scripts/fetch_archive.py --update --extract-reviews"
      
      - name: Generate dashboard data
        run: |
          echo "Generating dashboard statistics..."
          python scripts/04_generate_dashboard_data.py
      
      - name: Upload data to S3
        env:
          MY_AWS_ACCESS_KEY_ID: ${{ secrets.MY_AWS_ACCESS_KEY_ID }}
          MY_AWS_SECRET_ACCESS_KEY: ${{ secrets.MY_AWS_SECRET_ACCESS_KEY }}
          MY_DEFAULT_REGION: ${{ secrets.MY_DEFAULT_REGION }}
        run: |
          echo "Uploading data files to S3..."
          python scripts/upload_to_s3.py
      
      - name: Commit data changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add data files
          git add data/
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No data changes to commit"
          else
            git commit -m "Update data: $(date +'%Y-%m-%d %H:%M UTC')"
            
            # Pull with rebase to incorporate any remote changes
            git pull --rebase origin main
            
            # Push the changes
            git push origin main
            echo "Data updated and committed"
          fi
      
      - name: Upload data artifact
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-data
          path: data/dashboard_stats.json
          retention-days: 1

  build-deploy:
    name: Build and deploy site
    runs-on: ubuntu-latest
    needs: fetch-data
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Download data artifact
        uses: actions/download-artifact@v4
        with:
          name: dashboard-data
          path: data/
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build with Eleventy
        run: npm run build
      
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

